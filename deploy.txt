
#!/bin/bash

# UBI Tech Support - Standalone Deployment Script
# Target: /var/www/ubi-support
# Usage: bash deploy.txt

# Stop on any error
set -e

echo "ğŸš€ Starting Deployment (Standalone)..."

# 1. Pull latest code (Force sync with remote)
echo "ğŸ“¥ Fetching latest changes from Git..."
# We use fetch + reset to handle 'detached HEAD' states often found on build servers
git fetch --all
git reset --hard origin/main

# 2. CLEANUP: Remove old artifacts if present
echo "ğŸ§¹ Cleaning up workspace..."
rm -rf dist

# 3. Install Dependencies
echo "ğŸ“¦ Installing Dependencies... "
if [ ! -d "node_modules" ]; then
    npm install
else
    # Faster update if node_modules exists
    npm update
fi

# 4. Build the Application
echo "ğŸ› ï¸ Building App..."

# Check for API Key in .env
if [ -z "$API_KEY" ]; then
  if [ -f .env ]; then
    echo "ğŸ”‘ Loading API Key from .env file..."
    export $(grep -v '^#' .env | xargs)
  fi
fi

if [ -z "$API_KEY" ]; then
  echo "âŒ Error: API_KEY is missing!"
  echo "   Please create a .env file on the server with: API_KEY=your_key"
  exit 1
fi

npm run build

# 5. Deploy to Standalone Directory
echo "ğŸŒ Deploying to /var/www/ubi-support..."

# Create directory if not exists
sudo mkdir -p /var/www/ubi-support

# Clear old files in deployment directory
sudo rm -rf /var/www/ubi-support/*

# Copy new files
sudo cp -r dist/* /var/www/ubi-support/

# 6. Fix Permissions
echo "ğŸ”’ Fixing Permissions..."
sudo chown -R www-data:www-data /var/www/ubi-support
sudo chmod -R 755 /var/www/ubi-support

# 7. Restart Nginx
echo "ğŸ”„ Restarting Nginx..."
sudo systemctl restart nginx

echo "âœ… Deployment Complete!"
echo "ğŸ‘‰ Ensure your Nginx config points to: /var/www/ubi-support"
