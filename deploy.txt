#!/bin/bash

# UBI Tech Support - Automated Deployment Script
# Usage: bash deploy.txt

# Stop on any error
set -e

# git commit -a # Optional: Commit strictly only if you are on dev machine

echo "ğŸš€ Starting Deployment..."

# 1. Pull latest code
echo "ğŸ“¥ Pulling from GitHub..."
git pull

# 2. CLEANUP: Remove duplicate root files that conflict with src/
echo "ğŸ§¹ Cleaning up old root files..."
rm -f index.tsx index.css types.ts store.ts constants.ts App.tsx
rm -rf components services

# 3. Install Dependencies
echo "ğŸ“¦ Installing Dependencies... "
rm -rf node_modules package-lock.json
npm install

# 4. Build the Application
echo "ğŸ› ï¸ Building App..."

# SAFETY CHECK: Look for API Key in environment or .env file
if [ -z "$API_KEY" ]; then
  if [ -f .env ]; then
    echo "ğŸ”‘ Loading API Key from .env file..."
    export $(grep -v '^#' .env | xargs)
  fi
fi

if [ -z "$API_KEY" ]; then
  echo "âŒ Error: API_KEY is missing!"
  echo "   Please create a .env file on the server with: API_KEY=your_key"
  exit 1
fi

npm run build

# 5. Deploy to Web Server
echo "ğŸŒ Deploying to Nginx..."
# Clear old files
sudo rm -rf /var/www/html/*
# Copy new files
sudo cp -r dist/* /var/www/html/

# 6. Fix Permissions
echo "ğŸ”’ Fixing Permissions..."
sudo chown -R www-data:www-data /var/www/html
sudo chmod -R 755 /var/www/html

# 7. Restart Nginx
echo "ğŸ”„ Restarting Web Server..."
sudo systemctl restart nginx

echo "âœ… Deployment Complete! Visit http://13.229.219.21"